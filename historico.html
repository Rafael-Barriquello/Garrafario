<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Meus Pedidos - Garrafario</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
    }

    header {
      background-color: #2c3e50;
      color: white;
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo {
      font-size: 24px;
      font-weight: bold;
    }

    .menu a {
      color: white;
      text-decoration: none;
      margin-left: 20px;
      font-weight: bold;
    }

    .container {
      width: 80%;
      max-width: 800px;
      margin: 30px auto;
    }

    h2 {
      color: #333;
      border-bottom: 2px solid #27ae60;
      padding-bottom: 10px;
    }

    /* Card do Pedido */
    .pedido-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      overflow: hidden;
    }

    .pedido-header {
      background-color: #ecf0f1;
      padding: 15px;
      border-bottom: 1px solid #ddd;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #2c3e50;
    }

    .pedido-header .data {
      font-weight: bold;
    }

    .pedido-header .total {
      color: #27ae60;
      font-weight: bold;
      font-size: 1.1em;
    }

    .pedido-itens {
      padding: 15px;
    }

    .item-linha {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }

    .item-linha:last-child {
      border-bottom: none;
    }

    .item-nome {
      display: flex;
      align-items: center;
    }

    .item-thumb {
      width: 40px;
      height: 40px;
      object-fit: cover;
      border-radius: 4px;
      margin-right: 15px;
      background-color: #eee;
    }

    .status-badge {
        background-color: #27ae60;
        color: white;
        padding: 3px 8px;
        border-radius: 12px;
        font-size: 12px;
        margin-left: 10px;
    }

    .btn-voltar {
        display: inline-block;
        margin-top: 20px;
        padding: 10px 20px;
        background-color: #3498db;
        color: white;
        text-decoration: none;
        border-radius: 5px;
    }
    .btn-voltar:hover {
        background-color: #2980b9;
    }

    .empty-state {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
    }
  </style>
</head>
<body>

  <script src="data.js"></script>
  <script src="cliente_perfil.js"></script>

  <header>
    <div class="logo">Garrafario</div>
    <div class="menu">
      <a href="catalogo.html">⬅ Voltar ao Catálogo</a>
    </div>
  </header>

  <div class="container">
    <h2>Histórico de Pedidos</h2>
    
    <div id="listaPedidos">
        </div>

    <div style="text-align: center;">
        <a href="catalogo.html" class="btn-voltar">Continuar Comprando</a>
    </div>
  </div>

  <script>
    // 1. Verificação de Segurança (Apenas Clientes Logados)
    const usuarioLogado = JSON.parse(localStorage.getItem(LS_KEYS.LOGGED_USER));

    if (!usuarioLogado || usuarioLogado.tipo !== 'cliente') {
        alert("Você precisa estar logado como cliente para ver seus pedidos.");
        window.location.href = "paginaLogin.html";
    }

    // 2. Função para carregar histórico
    function carregarHistorico() {
        const container = document.getElementById("listaPedidos");
        container.innerHTML = "";

        // Tenta pegar do localStorage diretamente para garantir, 
        // caso a classe ClientePerfil tenha sido sobrescrita no data.js
        let pedidos = JSON.parse(localStorage.getItem('LSDATA_ORDERS')) || [];

        // Filtra apenas os pedidos deste usuário
        const meusPedidos = pedidos.filter(p => p.clienteId === usuarioLogado.id);

        // Ordena do mais recente para o mais antigo
        // Se a data for string ISO, new Date funciona. Se for dd/mm/aaaa, precisa tratar, 
        // mas como o id é timestamp, podemos ordenar pelo ID descrescente.
        meusPedidos.sort((a, b) => b.id - a.id);

        if (meusPedidos.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <h3>Você ainda não fez nenhum pedido.</h3>
                    <p>Que tal dar uma olhada no nosso catálogo?</p>
                </div>
            `;
            return;
        }

        meusPedidos.forEach(pedido => {
            let htmlItens = "";

            // Itera sobre os itens dentro do pedido
            pedido.itens.forEach(itemCarrinho => {
                // Busca detalhes do produto no 'data.js' via ID
                const produtoDetalhes = getProductById(itemCarrinho.id);
                
                // Fallback caso o produto tenha sido deletado do catálogo
                const nomeProduto = produtoDetalhes ? produtoDetalhes.nome : "Produto Indisponível (Removido)";
                const imgProduto = produtoDetalhes ? produtoDetalhes.imagem : "";
                const precoUnitario = produtoDetalhes ? produtoDetalhes.preco : 0;
                
                htmlItens += `
                    <div class="item-linha">
                        <div class="item-nome">
                            ${imgProduto ? `<img src="${imgProduto}" class="item-thumb">` : ''}
                            <span>${itemCarrinho.quantidade}x <strong>${nomeProduto}</strong></span>
                        </div>
                        <div>R$ ${(precoUnitario * itemCarrinho.quantidade).toFixed(2)}</div>
                    </div>
                `;
            });

            // Formata a data (se for timestamp ou string ISO)
            let dataFormatada = pedido.data;
            // Se for ISO ou timestamp, tenta formatar bonitinho
            if(pedido.data && (pedido.data.includes('-') || typeof pedido.data === 'number')) {
                 try {
                    const dataObj = new Date(pedido.data);
                    dataFormatada = dataObj.toLocaleDateString('pt-BR') + ' ' + dataObj.toLocaleTimeString('pt-BR', {hour: '2-digit', minute:'2-digit'});
                 } catch(e) {}
            }

            // Monta o Card HTML
            const cardHTML = `
                <div class="pedido-card">
                    <div class="pedido-header">
                        <div>
                            <span class="data">Pedido #${pedido.id}</span>
                            <br>
                            <small style="color: #7f8c8d">${dataFormatada}</small>
                            <span class="status-badge">Concluído</span>
                        </div>
                        <div class="total">${pedido.total}</div>
                    </div>
                    <div class="pedido-itens">
                        ${htmlItens}
                    </div>
                </div>
            `;

            container.innerHTML += cardHTML;
        });
    }

    // Inicializa
    carregarHistorico();

  </script>

</body>
</html>